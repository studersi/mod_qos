#
# $Id: QS_EventKBytesPerSecLimit.htt,v 1.4 2010-12-21 21:48:55 pbuchbinder Exp $
#
#   BrowserMatch QS_EventKBytesPerSecLimit  eventkbytespersec
#   QS_EventKBytesPerSecLimit  eventkbytespersec 202
#

INCLUDE scripts/ports

CLIENT

_BPS 2000 22
# 29427 bytes each request
# ~20req/sec
# ~640kb/sec 
_REQ server1 $QS_PORT_BASE1
__GET /aaa/index2.html HTTP/1.1
__Host: server1
__User-Agent: QS_EventKBytesPerSecLimit
__Connection: keep-alive
__
_MATCH headers "Connection: (.*)" CONNECTION
_EXPECT . "Revision"
_WAIT

_IF "$CONNECTION" MATCH "close"
_CLOSE
_END IF

_END BPS

_CLOSE
_REQ localhost $QS_PORT_BASE
__GET /qos HTTP/1.1
__Host: localhost
__Connection: keep-alive
__
_EXPECT . "200"
_EXPECT . "<!--3--><td>var=.eventkbytespersec.</a></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td style=.background-color: rgb....,...,....;.>[0-9]{2,3}&nbsp;ms</td><td>202</td>"
_WAIT
_CLOSE

_EXPECT EXEC "mod_qos.052.: byte rate limit, rule: var=.eventkbytespersec..202., kbytes/sec=.*, delay=.*ms"
_EXEC tail -1 logs/error_log

END
