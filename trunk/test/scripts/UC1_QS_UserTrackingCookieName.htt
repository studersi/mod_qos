#
# QS_UserTrackingCookieName utc /error-docs/cookie.html
# SetEnvIf                  DNT 1 DISABLE_UTC_ENFORCEMENT
#
# note: redirects GET requests only
#

INCLUDE scripts/ports

CLIENT

_REQ localhost $QS_PORT_BASE
__GET /index.html HTTP/1.1
__Host: localhost
__DNT: 1
__
_EXPECT . "200 OK"
_EXPECT . "this is the root index.html"
_WAIT

_REQ localhost $QS_PORT_BASE
__POST /index.html HTTP/1.1
__Host: localhost
__Content-Type: text/plain
__Content-Length: AUTO
__
__hallo
_EXPECT . "200 OK"
_EXPECT . "this is the root index.html"
_WAIT

_REQ localhost $QS_PORT_BASE
__GET /index.html HTTP/1.1
__Host: localhost
__
_EXPECT . "302"
_EXPECT . "Location: http://127.0.0.1:${QS_PORT_BASE}/error-docs/cookie.html"
_MATCH headers "Set-Cookie: utc=(.*); Path=/" UTC
_MATCH headers "Location: http://127.0.0.1:${QS_PORT_BASE}(.*)" LOC
_WAIT
_CLOSE

_REQ localhost $QS_PORT_BASE
__GET $LOC HTTP/1.1
__Host: localhost
__Cookie: utc=$UTC
__
_EXPECT . "302"
_EXPECT . "Location: http://127.0.0.1:${QS_PORT_BASE}/index.html"
_EXPECT . "!Set-Cookie"
_MATCH headers "Location: http://127.0.0.1:${QS_PORT_BASE}(.*)" LOC
_WAIT
_CLOSE

_REQ localhost $QS_PORT_BASE
__GET $LOC HTTP/1.1
__Host: localhost
__Cookie: utc=$UTC
__
_EXPECT . "200 OK"
_EXPECT . "this is the root index.html"
_WAIT
_SLEEP 100
_MATCH EXEC "u=(.*) - -" TC1
_EXEC tail -1 logs/access_log

_REQ localhost $QS_PORT_BASE
__GET $LOC HTTP/1.1
__Host: localhost
__Cookie: utc=$UTC
__
_EXPECT . "200 OK"
_EXPECT . "this is the root index.html"
_WAIT
_SLEEP 100
_MATCH EXEC "u=(.*) - -" TC2
_EXEC tail -1 logs/access_log

_IF "${TC1}" NOT MATCH "${TC2}"
_EXIT FAILED
_END IF


END
