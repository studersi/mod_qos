#
# $Id: 029_QS_SrvMaxConn.htt,v 1.5 2016-11-26 19:49:55 pbuchbinder Exp $
#
#   QS_SrvMaxConn              45
#

INCLUDE scripts/ports

CLIENT 45
_SLEEP 5000
_REQ localhost $QS_PORT_BASE
__GET /cgi-local/sleep.cgi?s=4 HTTP/1.1
__Host: localhost
__Connection: keep-alive
__
_EXPECT . "done"
_EXPECT . "200 OK"
_WAIT
_CLOSE

END

CLIENT 1
_SLEEP 6000
_REQ localhost $QS_PORT_BASE
_EXPECT ERROR "Connection reset by peer"
__GET /cgi-local/sleep.cgi?s=3 HTTP/1.1
__Host: localhost
__Connection: keep-alive
__
_WAIT
_CLOSE
_SLEEP 100
_EXPECT EXEC "mod_qos\(030\): access denied, QS_SrvMaxConn rule: max=45, concurrent connections=46"
_EXEC tail -3 logs/error_log

_SLEEP 14000
_REQ localhost $QS_PORT_BASE
__GET /cgi-local/sleep.cgi?s=3 HTTP/1.1
__Host: localhost
__Connection: keep-alive
__
_EXPECT . "done"
_EXPECT . "200 OK"
_WAIT

END
