#
#   QS_ErrorPage                  /error-docs/error.html
#   QS_LocRequestLimitDefault                              10
#   QS_LocRequestLimitMatch       "^.*\.gif$"              5
#   QS_LocRequestLimit            /images                  8
#   QS_LocRequestLimit            /a                       4
#   QS_LocKBytesPerSecLimit       /a                       3000
#   QS_LocRequestLimitMatch       "^(/b/|/c/).*$"          3
#

INCLUDE scripts/ports

CLIENT
_EXEC ./sleep.sh

_SET bytes=0
_DATE:GET_TIME start

# ~5000 kbytes/sec without limitation
_LOOP 25
_RPS 10 5
_REQ localhost $QS_PORT_BASE
__GET /a/image.iso HTTP/1.1
__Host: localhost
__
_MATCH headers "Content-Length: ([0-9]*)" ct
_EXPECT . "200 OK"
_WAIT
_MATH:OP $bytes ADD $ct bytes
_END RPS
_CLOSE
_END LOOP

_DATE:GET_TIME end
_MATH:OP $end SUB $start duration
_MATH:OP $bytes DIV $duration bms
_DEBUG "kbytes/sec (netto) $bms"
_IF $bms GT 3300
_EXIT FAILED
_END IF
_IF $bms LT 2700
_EXIT FAILED
_END IF

_EXPECT EXEC ";b/s;3[0-9]{6,6};"
_EXEC tail -1 logs/qs_log

END
