#
# $Id: QS_PermitUriJSON.htt,v 1.3 2010-11-03 21:12:31 pbuchbinder Exp $
#


INCLUDE scripts/ports

CLIENT

# invalid type (string without quotes)
_REQ localhost $QS_PORT_BASE
__POST /qos/parp/json?session=123 HTTP/1.1
__Host: localhost
__Content-Type: application/json
__Content-Length: AUTO
__Req: 1
__
__ {
__    "name": "Jack (\"Bee\") Nimble", 
__    "format": {
__        "type":       "rect",
__        "width":      1920, 
__        "height":     huge,
__        "interlace":  false, 
__        "frame rates": [ 24 , 30 , 60, 72 ]
__    }
__ }
_EXPECT . "500 Internal Server Error"
_EXPECT . "code=048"
_WAIT
_CLOSE

# rule violation (json)
_REQ localhost $QS_PORT_BASE
__POST /qos/parp/json?session=123 HTTP/1.1
__Host: localhost
__Content-Type: application/json
__Content-Length: AUTO
__Req: 1
__
__ {
__    "name": "Jack (\"Bee\") Nimble", 
__    "format": {
__        "type":       "0000",
__        "width":      1920, 
__        "height":     1080,
__        "interlace":  false, 
__        "frame rates": [ 24 , 30 , 60, 72 ]
__    }
__ }
_EXPECT . "500 Internal Server Error"
_EXPECT . "code=041"
_WAIT
_CLOSE

_SLEEP 200
_EXEC tail -1 logs/qsaudit_log | awk '{print $4}' > in.log
_EXEC ../util/src/qsfilter2 -i in.log -v 0 | grep QS_PermitUri > conf/json.conf
_EXEC ./ctl.sh restart 2>/dev/null 1>/dev/null
_EXEC rm in.log
_SLEEP 1000

# same test but with updated ruleset
_REQ localhost $QS_PORT_BASE
__POST /qos/parp/json?session=123 HTTP/1.1
__Host: localhost
__Content-Type: application/json
__Content-Length: AUTO
__Req: 1
__
__ {
__    "name": "Jack (\"Bee\") Nimble", 
__    "format": {
__        "type":       "0000",
__        "width":      1920, 
__        "height":     1080,
__        "interlace":  false, 
__        "frame rates": [ 24 , 30 , 60, 72 ]
__    }
__ }
_EXPECT . "!500 Internal Server Error"
_EXPECT . "!code=041"
_EXPECT . "200 OK"
_EXPECT . "<h2>mod_qos"
_WAIT
_CLOSE

# rule violation (query)
_REQ localhost $QS_PORT_BASE
__POST /qos/parp/json?session=abc HTTP/1.1
__Host: localhost
__Content-Type: application/json
__Content-Length: AUTO
__Req: 1
__
__ {
__    "name": "Jack (\"Bee\") Nimble", 
__    "format": {
__        "type":       "rect",
__        "width":      1920, 
__        "height":     1080,
__        "interlace":  false, 
__        "frame rates": [ 24 , 30 , 60, 72 ]
__    }
__ }
_EXPECT . "500 Internal Server Error"
_EXPECT . "code=041"
_WAIT
_CLOSE

# valid message
_REQ localhost $QS_PORT_BASE
__POST /qos/parp/json?session=123 HTTP/1.1
__Host: localhost
__Content-Type: application/json
__Content-Length: AUTO
__Req: 1
__
__ {
__    "name": "Jack (\"Bee\") Nimble", 
__    "format": {
__        "type":       "rect",
__        "width":      1920, 
__        "height":     1080,
__        "interlace":  false, 
__        "frame rates": [ 24 , 30 , 60, 72 ]
__    }
__ }
_EXPECT . "200 OK"
_EXPECT . "<h2>mod_qos"
_WAIT
_CLOSE

END
