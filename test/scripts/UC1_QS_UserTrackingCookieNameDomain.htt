#
# $Id$
#
# QS_SessionKey             1234567890
# QS_UserTrackingCookieName utc /error-docs/cookie.html session
#

INCLUDE scripts/ports

CLIENT

_REQ localhost $QS_PORT_BASE
__GET /index.html HTTP/1.1
__Host: localhost
__
_EXPECT . "302"
_EXPECT . "Location: http://127.0.0.1:${QS_PORT_BASE}/error-docs/cookie.html"
_MATCH headers "^Set-Cookie: utc=(.*); Path=/; Max-Age=25920000; Domain=.joebar.ch$" UTC
_MATCH headers "Location: http://127.0.0.1:${QS_PORT_BASE}(.*)" LOC
_WAIT
_CLOSE
_SLEEP 100
# ID generated by mod_qos, example K8BE-hTsBAB-AAEBAAAAAIh1AAAA9-9HAauUUgAAAAA
_EXPECT EXEC "GET /index.html HTTP/1.1\" 302 ... \"-\" 0 - u; - id=[a-zA-Z0-9_@-]{32,32} "
_EXEC tail -1 logs/access_log

_REQ localhost $QS_PORT_BASE
__GET $LOC HTTP/1.1
__Host: localhost
__Cookie: utc=$UTC
__
_EXPECT . "302"
_EXPECT . "Location: http://127.0.0.1:${QS_PORT_BASE}/index.html"
_EXPECT . "!Set-Cookie"
_MATCH headers "Location: http://127.0.0.1:${QS_PORT_BASE}(.*)" LOC
_WAIT
_CLOSE

_REQ localhost $QS_PORT_BASE
__GET $LOC HTTP/1.1
__Host: localhost
__Cookie: utc=$UTC
__
_EXPECT . "200 OK"
_EXPECT . "this is the root index.html"
_EXPECT . "!Set-Cookie"
_WAIT
_SLEEP 100
_MATCH EXEC "u=(.*) - -" TC1
_EXEC tail -1 logs/access_log

_SLEEP 400

_REQ localhost $QS_PORT_BASE
__GET $LOC HTTP/1.1
__Host: localhost
__Cookie: utc=$UTC
__
_EXPECT . "200 OK"
_EXPECT . "this is the root index.html"
_EXPECT . "!Set-Cookie"
_WAIT
_CLOSE
_SLEEP 100
_MATCH EXEC "u=(.*) - -" TC2
_EXEC tail -1 logs/access_log

_IF "${TC1}" NOT MATCH "${TC2}"
_EXIT FAILED
_END IF

_IF "${TC1}" NOT MATCH "[a-z0-9]+"
_EXIT FAILED
_END IF

END
