#
# $Header: /home/cvs/m/mo/mod-qos/src/test/conf/ucn.conf.tmpl,v 2.20 2014-01-17 15:27:28 pbuchbinder Exp $
#
# mod_qos test configuration using use cases using multiple directives/features
#
# See http://opensource.adnovum.ch/mod_qos/ for further
# details about mod_qos.
#
# Copyright (C) 2013-2014 Pascal Buchbinder
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
# MA 02110-1301, USA.
#

ServerName              127.0.0.1

<IfDefine !ucnm>
<IfModule worker.c>
 StartServers            1
 ServerLimit             1
 MinSpareThreads         5
 MaxSpareThreads         64
 ThreadsPerChild         64
 MaxClients              64
 MaxRequestsPerChild     0
</IfModule>
<IfModule prefork.c>
 StartServers            64
 ServerLimit             64
 MinSpareServers         4
 MaxSpareServers         64
</IfModule>
</IfDefine>

<IfDefine ucnm>
<IfModule worker.c>
 StartServers            1
 ServerLimit             2
 MinSpareThreads         5
 MaxSpareThreads         32
 ThreadsPerChild         16
 MaxClients              32
 MaxRequestsPerChild     32
</IfModule>
<IfModule prefork.c>
 StartServers            10
 ServerLimit             32
 MinSpareServers         4
 MaxSpareServers         32
</IfModule>
</IfDefine>

User                    ##USR##
Group                   users
ServerAdmin             webmaster@127.0.0.1
ServerRoot              ##ROOT##
DocumentRoot            ##ROOT##/htdocs
ServerSignature         off
HostnameLookups         off
UseCanonicalName        on
LockFile                ##ROOT##/logs/accept.lock
Timeout                 30
KeepAlive               on
MaxKeepAliveRequests    100
KeepAliveTimeout        5

LimitRequestFields      30
QS_EnableInternalIPSimulation off

Options                 FollowSymLinks Indexes Includes
DefaultType             text/plain
AddType                 text/html .shtml
AddOutputFilter         INCLUDES .shtml

LogFormat               "%h %l %u %t \"%r\" %>s %b \"%{User-Agent}i\" %T %{mod_qos_cr}e %{mod_qos_ev}e %{mod_qos_con}e id=%{UNIQUE_ID}e %{qs_special}e %{content-length}i #%P"

LogLevel                warn
ErrorLog                ##ROOT##/logs/error_log
TransferLog             "|##ROOT##/../util/src/qsrotate -o ##ROOT##/logs/access_log -z -g 4 -s 3600 -f"
CustomLog               "|##ROOT##/../util/src/qslog -o ##ROOT##/logs/qs_log -f ISBDUQ" "%h %>s %b %D %{mod_qos_user_id}e %{mod_qos_ev}o '%v:%U'"

PidFile                 ##ROOT##/logs/apache.pid
CoreDumpDirectory       ##ROOT##/logs/

TypesConfig             conf/mime.types
LoadModule              status_module ##ROOT##/../httpd/modules/generators/.libs/mod_status.so
LoadModule              proxy_module ##ROOT##/../httpd/modules/proxy/.libs/mod_proxy.so
LoadModule              proxy_http_module ##ROOT##/../httpd/modules/proxy/.libs/mod_proxy_http.so
LoadModule              qos_module ##ROOT##/../httpd/modules/qos/.libs/mod_qos.so
LoadModule              parp_module libexec/mod_parp.so
LoadModule              setenvifplus_module libexec/mod_setenvifplus.so
<IfDefine ucnd>
LoadModule              qtest_module ##ROOT##/../httpd/modules/qtest/.libs/mod_qtest.so
</IfDefine>

NameVirtualHost         127.0.0.1:##QS_PORT_BASE##
Listen                  127.0.0.1:##QS_PORT_BASE##

<IfDefine ucnb>
QS_ClientIpFromHeader         X-Forwarded-For
SetEnvIfPlus                  Request_Query limitme  QS_Limit01
SetEnvIfPlus                  User-Agent    allowme  QS_Limit02
QS_ClientEventLimitCount      10    5 QS_Limit01
QS_ClientEventLimitCount      10000 5 QS_Limit02
</IfDefine>

<IfDefine ucnc>
SetEnvIfPlus                  Request_URI     ^(/htt/aaa/|/htt/ccc/).* EventApp
QS_SetEnvIfStatus             302                          Event302
QS_SetEnvIf                   EventApp Event302        QS_LimitCL=1
QS_ClientEventLimitCount      3 2 QS_LimitCL
</IfDefine>

<IfDefine ucnd>
SetEnvIfPlus                  Request_URI     ^(/htt/aaa/|/htt/ccc/|/qsforbidden/limit).* EventApp
# note: "qsforbidden=true" is set by mod_qtest when accessing /qsforbidden/
QS_SetEnvRes                  qsforbidden   blockme          EventForbidden
QS_SetEnvRes                  qsforbidden   true             EventForbidden
QS_SetEnvRes                  qsforbidden   you              EventForbidden
QS_SetEnvIf                   EventApp      EventForbidden   QS_LimitCL=1
QS_ClientEventLimitCount      3             2                QS_LimitCL
</IfDefine>

<IfDefine ucne>
QS_ClientIpFromHeader         X-Forwarded-For
</IfDefine>

<IfDefine ucng>
QS_SrvMaxConnPerIP                      100
Browsermatch  (slurp|googlebot|bingbot) Spider
SetEnvIf      QS_IPConn                 [3-9][0-9]*  ThreeOrMoreConnections
QS_SetEnvIf   ThreeOrMoreConnections    Spider       LimitSpider=yes
QS_RedirectIf LimitSpider               .*           http://127.0.0.1/redirect.html
</IfDefine>

<IfDefine ucni>
SetEnvIf                      Content-Length [0-9]{2,} SerialPostSize
SetEnvIf                      Request_URI ^/a SerialPostURL
QS_SetEnvIf                   SerialPostSize SerialPostURL   QS_Serialize=yes
QS_ClientSerialize
</IfDefine>

<IfDefine ucnj>
QS_ClientIpFromHeader         Y-Forwarded-For
SetEnvIfPlus                  User-Agent serializeme QS_Serialize=yes
QS_ClientSerialize
</IfDefine>

<IfDefine ucnl>
QS_ClientIpFromHeader         Y-Forwarded-For

QS_MileStone       deny       "^[A-Z]+ /index.html\?id=1 HTTP/...$"
QS_MileStone       deny       "^[A-Z]+ /index.html\?id=2 HTTP/...$"
QS_MileStone       deny       "^[A-Z]+ /index.html\?id=3 HTTP/...$"

SetEnvIfPlus      Request_URI  ^/index.html$ URILIMIT
SetEnvIfPlus    Request_Query  ^id=1$        QUERYLIMIT1
SetEnvIfPlus    Request_Query  ^id=2$        QUERYLIMIT2
SetEnvIfPlus    Request_Query  ^id=3$        QUERYLIMIT3
QS_SetEnvIf     URILIMIT  QUERYLIMIT1        ClientLimit1=y
QS_SetEnvIf     URILIMIT  QUERYLIMIT2        ClientLimit2=y
QS_SetEnvIf     URILIMIT  QUERYLIMIT3        ClientLimit3=y
QS_SetEnvIf     URILIMIT  QUERYLIMIT1        QS_Cond=1
QS_SetEnvIf     URILIMIT  QUERYLIMIT2        QS_Cond=2
QS_SetEnvIf     URILIMIT  QUERYLIMIT3        QS_Cond=3
QS_CondClientEventLimitCount    2    5       ClientLimit1 ^1$ 
QS_CondClientEventLimitCount    2    5       ClientLimit2 ^2$
QS_CondClientEventLimitCount    2    5       ClientLimit3 ^3$

ResponseHeaderPlus set X-ClientLimit1 ${ClientLimit1_Counter}
ResponseHeaderPlus set X-ClientLimit2 ${ClientLimit2_Counter}
ResponseHeaderPlus set X-ClientLimit3 ${ClientLimit3_Counter}
</IfDefine>

<VirtualHost 127.0.0.1:##QS_PORT_BASE##>
   ServerName                 127.0.0.1

   ProxyRequests              Off
   <Proxy *>
      Order deny,allow
      Allow from all
   </Proxy>

   ProxyPass                  /error-docs !
   ProxyPass                  /status !
   ProxyPass                  /test !
   ProxyPass                  /a !
   ProxyPass                  /b !
   ProxyPass                  /c !
   ProxyPass                  /qos !
   ProxyPass                  /cgi-local !
   ProxyPass                  /qsforbidden !
   ProxyPass                  /htt http://localhost:##QS_PORT_BASE6##/htt retry=0
   ProxyPassReverse           /htt http://localhost:##QS_PORT_BASE6##/htt

   ScriptAlias /cgi-local/    ##ROOT##/htdocs/cgi-local/
   ScriptAlias /a/            ##ROOT##/htdocs/cgi-local/
   ScriptAlias /b/            ##ROOT##/htdocs/cgi-local/
   ScriptAlias /c/            ##ROOT##/htdocs/cgi-local/
   ScriptAlias /x/            ##ROOT##/htdocs/cgi-local/
   ScriptAlias /images/       ##ROOT##/htdocs/cgi-local/

<IfDefine ucna>
   # Documentation's sample configuration:
   QS_ErrorPage                  /error-docs/error.html
   QS_LocRequestLimitDefault                              10
   QS_LocRequestLimitMatch       "^.*\.gif$"              5
   QS_LocRequestLimit            /images                  8
   QS_LocRequestLimit            /a                       4
   QS_LocKBytesPerSecLimit       /a                       3000
   QS_LocRequestLimitMatch       "^(/b/|/c/).*$"          3
</IfDefine>

<IfDefine ucnb>
   <Location />
      # redirect after 5 requests except "allowme" client
      SetEnvIfPlus               QS_Limit01_Counter 5            QS_Redirect=1 late
      SetEnvIfPlus               QS_Limit02_Counter [1-9][0-9]* !QS_Redirect   late
   </Location>
   QS_RedirectIf                 QS_Redirect (.+) http://127.0.0.1/redirect.html?c=$1
</IfDefine>

<IfDefine ucnf>
   SetEnvIfPlus                  Request_Query limitMe limitEvent
   QS_EventLimitCount            limitEvent 5 3
   QS_RedirectIf                 limitEvent_Counter (3) http://127.0.0.1/redirect.html?c=$1
</IfDefine>

<IfDefine ucnk>
   SetEnvIfPlusNoCase            Cookie JSESSIONID  hasSession
   SetEnvIfPlus                  Request_URI ^/content limitUrl
   QS_SetEnvIf                   !hasSession limitUrl limitAccess=yes
   QS_EventLimitCount            limitAccess 2 2
</IfDefine>

<IfDefine ucnh>
   # max five requests to /htt/service posing more than 9 bytes
   SetEnvIf                      Content-Length [0-9]{2,} MaxPostSize
   SetEnvIf                      Request_URI /htt/service MaxPostURL
   QS_SetEnvIf                   MaxPostSize MaxPostURL   MaxPost=yes
   QS_EventRequestLimit          MaxPost                  4
   # no chunked post here (otherwise, we can't limit the req body size)
   SetEnvIf                      Request_Method POST      IsPost
   SetEnvIf                      Content-Length [0-9]     HasContentLength
   QS_SetEnvIf                   IsPost !HasContentLength ChunkedPost=yes
   <Location /htt>
     QS_DenyEvent                +denychunked deny        ChunkedPost
   </Location>
</IfDefine>

   <Location /cgi-local>
       Options ExecCGI -MultiViews +SymLinksIfOwnerMatch
       Order allow,deny
       Allow from all
   </Location>

<IfDefine ucnm>
   SetEnvIfPlus Request_Query errorpage QS_ErrorPage=/error-docs/error.html
   QS_LocRequestLimitDefault                              30
   <Location /status>
       SetHandler server-status
       QS_DenyQuery +id01 deny dontallowme
   </Location>
</IfDefine>

</VirtualHost>
